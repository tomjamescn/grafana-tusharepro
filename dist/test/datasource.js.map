{"version":3,"sources":["../../src/datasource.js"],"names":["String","prototype","splice","start","delCount","newSubStr","slice","Math","abs","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","name","tushareproToken","jsonData","tusharepro_token","apiUrl","tusharepro_api","q","t","Promise","resolve","setTimeout","options","retryInterval","datasourceRequest","url","method","headers","data","api","code","end","then","resp","status","fieldIndex","fields","indexOf","field","ts","items","datapoints","map","parseFloat","tup","Date","getTime","reverse","obj","target","catch","console","log","err","errors","message","quandl_error","reject","that","range","from","toISOString","substring","replace","to","targets","filter","hide","proms","getTimeSeries","all","response","title","option","ret","mapToTextValue","text","value","result","d","i","isObject"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nif (!String.prototype.splice) {\n  /**\n   * {JSDoc}\n   *\n   * The splice() method changes the content of a string by removing a range of\n   * characters and/or adding new characters.\n   *\n   * @this {String}\n   * @param {number} start Index at which to start changing the string.\n   * @param {number} delCount An integer indicating the number of old chars to remove.\n   * @param {string} newSubStr The String that is spliced in.\n   * @return {string} A new string with the spliced substring.\n   */\n  String.prototype.splice = function (start, delCount, newSubStr) {\n    return this.slice(0, start) + newSubStr + this.slice(start + Math.abs(delCount));\n  };\n}\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.tushareproToken = instanceSettings.jsonData.tusharepro_token;\n    this.apiUrl = instanceSettings.jsonData.tusharepro_api;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  delay(t) {\n    return new Promise(function (resolve) {\n      setTimeout(resolve, t)\n    });\n  }\n\n  getTimeSeries(options, retryInterval) {\n    return this.backendSrv.datasourceRequest({\n      url: this.apiUrl,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',\n        'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept'\n      },\n      data: {\n        \"api_name\": options.api,\n        \"token\": this.tushareproToken,\n        \"params\": {\n          \"ts_code\": options.code,\n          \"start_date\": options.start,\n          \"end_date\": options.end\n        }\n      }\n    }).then(resp => {\n      if (resp.status === 200 && resp.data.code == 0) {\n        var fieldIndex = resp.data.data.fields.indexOf(options.field);\n        var ts = resp.data.data.items;\n\n        var datapoints = _.map(ts, tup => {\n          return [parseFloat(tup[fieldIndex]), new Date(tup[1].splice(6, 0, \"-\").splice(4, 0, \"-\")).getTime()]\n        }).reverse();\n\n\n        var obj = {\n          target: options.code,\n          datapoints: datapoints\n        };\n\n        return obj;\n      }\n      return null;\n    }).catch(err => {\n      console.log(err)\n      if (err.status == 404 || retryInterval > 5000) {\n        var errors = {\n          message: \"Error getting time series\"\n        }\n        if (err.data && err.data.quandl_error) {\n          errors = {\n            message: err.data.quandl_error.message\n          };\n        }\n        else if (retryInterval > 10000) {\n          var errors = {\n            message: \"Request timed out\"\n          }\n        }\n        return this.q.reject(errors);\n      }\n\n      var that = this;\n      /*\n      return this.delay(retryInterval).then(function () {\n        return that.getTimeSeries(options, retryInterval * 2);\n      })\n      */\n    });\n  }\n\n  query(options) {\n    var start = options.range.from.toISOString().substring(0, 10).replace('-', '');\n    var end = options.range.to.toISOString().substring(0, 10).replace('-', '');\n\n\n    options.targets = options.targets.filter(t => !t.hide);\n\n    var proms = _.map(options.targets, target => {\n      return this.getTimeSeries({api: target.api, code: target.code, field: target.field, start: start, end: end}, 2000);\n    });\n    return Promise.all(proms)\n      .then(data => {\n        return {data: data}\n      })\n  }\n\n  testDatasource() {\n    console.log(\"test123\")\n    return this.backendSrv.datasourceRequest({\n      url: this.apiUrl,\n      method: \"POST\",\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',\n        'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept'\n      },\n      data: {\n        \"api_name\": \"stock_basic\",\n        \"token\": this.tushareproToken,\n        \"params\": {\n          \"list_status\": \"P\"\n        }\n      }\n    }).then(response => {\n      if (response.status === 200 && response.data.code == 0) {\n        return {status: \"success\", message: \"测试成功\", title: \"Success\"};\n      }\n    });\n  }\n\n  metricFindQuery(options) {\n    return new Promise(option => {\n      if (option.api == \"\") {\n      }\n      var ret = this.mapToTextValue([\n        {text: '开盘价', value: 2},\n        {text: '收盘价', value: 5}\n      ]);\n      return ret;\n    });\n  }\n\n  mapToTextValue(result) {\n    return _.map(result, (d, i) => {\n      if (d && d.text && d.value) {\n        return {text: d.text, value: d.value};\n      } else if (_.isObject(d)) {\n        return {text: d, value: i};\n      }\n      return {text: d, value: d};\n    });\n  }\n}\n"]}